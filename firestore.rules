rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the owner of the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Validate that a field is a valid difficulty enum
    function isValidDifficulty(value) {
      return value in ['Easy', 'Medium', 'Hard', 'Epic'];
    }
    
    // Validate that a field is a valid skill category
    function isValidSkillCategory(value) {
      return value in ['Physical', 'Mental', 'Professional', 'Social', 'Creative', 'Default'];
    }
    
    // ==========================================
    // USERS COLLECTION
    // ==========================================
    match /users/{userId} {
      // Allow authenticated users to read any user's public profile (for leaderboards, friend search)
      allow read: if isAuthenticated();
      
      // Users can only write to their own document
      allow write: if isOwner(userId);
      
      // Friends subcollection - only owner can read/write
      match /friends/{friendId} {
        allow read, write: if isOwner(userId);
      }
      
      // Tasks subcollection - only owner can read/write
      match /tasks/{taskId} {
        allow read, write: if isOwner(userId);
      }
      
      // Quests subcollection - only owner can read/write
      match /quests/{questId} {
        allow read, write: if isOwner(userId);
      }
      
      // Oracle Chat subcollection - only owner can read/write
      match /oracleChat/{messageId} {
        allow read, write: if isOwner(userId);
      }
      
      // Active Challenges subcollection - only owner can read/write
      match /activeChallenges/{challengeId} {
        allow read, write: if isOwner(userId);
      }
      
      // History subcollection - only owner can read/write
      match /history/{date} {
        allow read, write: if isOwner(userId);
      }
      
      // Archived History subcollection - only owner can read/write
      match /archivedHistory/{archiveId} {
        allow read, write: if isOwner(userId);
      }
      
      // Subscription subcollection - owner can read, only Cloud Functions can write
      match /subscription/{docId} {
        allow read: if isOwner(userId);
        allow write: if false; // Only Cloud Functions can write
      }
      
      // Notifications subcollection - owner can read and update (mark as read), only Cloud Functions can create/delete
      match /notifications/{notificationId} {
        allow read: if isOwner(userId);
        allow update: if isOwner(userId) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
        allow create, delete: if false; // Only Cloud Functions can create/delete
      }
      
      // Webhook Events subcollection - only Cloud Functions can access (for debugging/audit)
      match /webhookEvents/{eventId} {
        allow read, write: if false; // Only Cloud Functions can access
      }
      
      // Goals subcollection - only owner can read/write
      match /goals/{goalId} {
        allow read, write: if isOwner(userId);
      }
      
      // Templates subcollection - only owner can read/write
      match /templates/{templateId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // ==========================================
    // FRIEND REQUESTS COLLECTION
    // ==========================================
    match /friendRequests/{requestId} {
      // Allow reading requests where user is sender or recipient
      allow read: if isAuthenticated() 
                  && (resource.data.fromUID == request.auth.uid 
                      || resource.data.toUID == request.auth.uid);
      
      // Allow listing/querying requests for the authenticated user
      allow list: if isAuthenticated();
      
      // Sender can create requests (must set themselves as fromUID)
      allow create: if isAuthenticated() 
                    && request.resource.data.fromUID == request.auth.uid
                    && request.resource.data.status == 'pending';
      
      // Recipient can update (accept/reject/block)
      allow update: if isAuthenticated() 
                    && resource.data.toUID == request.auth.uid
                    && request.resource.data.status in ['accepted', 'rejected', 'blocked'];
      
      // Sender can delete (cancel their own request)
      allow delete: if isAuthenticated() 
                    && resource.data.fromUID == request.auth.uid;
    }
    
    // ==========================================
    // CHALLENGES COLLECTION
    // ==========================================
    match /challenges/{challengeId} {
      // Creator can create a new challenge
      allow create: if isAuthenticated() 
                    && request.resource.data.creatorUID == request.auth.uid
                    && request.auth.uid in request.resource.data.partnerIds;
      
      // Participants can read the challenge
      allow read: if isAuthenticated() 
                  && request.auth.uid in resource.data.partnerIds;
      
      // Participants can update the challenge (for task completion, etc.)
      allow update: if isAuthenticated() 
                    && request.auth.uid in resource.data.partnerIds;
      
      // Only creator can delete (cancel) the challenge
      allow delete: if isAuthenticated() 
                    && resource.data.creatorUID == request.auth.uid;
    }
    
    // ==========================================
    // CONFIG COLLECTION
    // ==========================================
    match /config/{document} {
      // Maintenance document - public read access, admin write only
      match /maintenance {
        // Allow anyone to read maintenance status (even unauthenticated)
        allow read: if true;
        
        // Only allow writes from Cloud Functions/Admin SDK
        // (In production, you'd set this via admin panel or cloud functions)
        allow write: if false;
      }
      
      // Default: deny access to other config documents
      allow read, write: if false;
    }
  }
}
